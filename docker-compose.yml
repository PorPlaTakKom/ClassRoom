version: "3.9"

services:
  livekit:
    image: livekit/livekit-server:v1.6.2
    container_name: livekit
    command: livekit-server
    environment:
      LIVEKIT_KEYS: ${LIVEKIT_KEYS}
    ports:
      - "7880:7880"                     # HTTP / WS
      - "7881:7881"                     # TCP RTC fallback
      - "50000-51000:50000-51000/udp"   # UDP media
    restart: unless-stopped

  server:
    build:
      context: ./server
    container_name: backend
    environment:
      NODE_ENV: production
      LIVEKIT_API_KEY: ${LIVEKIT_API_KEY}
      LIVEKIT_API_SECRET: ${LIVEKIT_API_SECRET}
      LIVEKIT_URL: ${LIVEKIT_URL}
    depends_on:
      - livekit
    expose:
      - "4000"
    restart: unless-stopped

  client:
    build:
      context: ./client
    container_name: frontend
    environment:
      DOMAIN: ${DOMAIN}
      ACME_EMAIL: ${ACME_EMAIL}
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - server
    volumes:
      - caddy_data:/data
      - caddy_config:/config
    restart: unless-stopped

volumes:
  caddy_data:
  caddy_config:
